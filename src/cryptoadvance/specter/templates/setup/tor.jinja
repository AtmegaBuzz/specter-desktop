{% extends "setup/setup_page.jinja" %}

{% block setup %}
    <div style="display: flex; justify-content: center;" >
        <img style="width: 100px;" src="{{ url_for('static', filename='img/ghost_3d.png') }}" data-style="width: 60px;"/> 
        <img style="width: 50px; margin: 20px;" src="{{ url_for('static', filename='img/arrow-right.svg') }}" data-style="width: 60px;" class="svg-white"/>&nbsp;
        <img style="width: 95px;" data-style="width: 60px;" src="{{ url_for('static', filename='img/tor.svg') }}"/><br>
    </div>
    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 100px;">
        <h1 style="text-align: center;">{{ _("Setup Tor daemon") }} </h1>
        <br><br>
        <div class="row" style="display: flex; justify-content: center; flex-wrap: wrap;">
            {% if nextURL == 'setup_endpoint.node_type'%}
                <button class="btn wizard-btn action" style="background-color: #4C5E72;" onclick="skipTorSetup()">{{ _("Skip") }}</button>
            {% endif %} 
            <button type="button" class="btn wizard-btn action" style="background-color: #2C68C1;" id="setup-tor-button" onclick="setupTorDaemon()">{{ _("Setup Tor") }}</button>
        </div>
    </div>
{% endblock %}

{% block setup_scripts %}
    <script>

        function skipTorSetup(){
            window.location.href = "{{ url_for('setup_endpoint.node_type') }}"
        }

        async function setupTorDaemon() {
            let url = "{{ url_for('setup_endpoint.setup_tor') }}";
            var formData = new FormData();
            formData.append('csrf_token', '{{ csrf_token() }}');
            try {
                const response = await fetch(
                    url,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                if(response.status != 200){
                    showError(await response.text());
                    return;
                }
                const jsonResponse = await response.json();
                if ("success" in jsonResponse) {
                    showNotification(jsonResponse.success);
                    document.getElementById('setup-tor-button').classList.add('hidden');
                    startProgressCheck('torbrowser', "{{ url_for(nextURL) }}");
                    return;
                } if (jsonResponse.error == "Tor is already installed") {
                    window.location.href = "{{ url_for(nextURL) }}";
                }
                showError(jsonResponse.error, 4000);
            }  catch(e) {
                showError(`{{ _("Failed to download Tor daemon...") }}`);
                showError(e);
            }
        }
    </script>
{% endblock %}
